name: Release

on:
  push:
    tags:
      - "v*"

permissions: {}

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Validate tag matches VERSION
        run: |
          VERSION="$(tr -d '[:space:]' < VERSION)"
          TAG="${GITHUB_REF_NAME#v}"
          if [ "$TAG" != "$VERSION" ]; then
            echo "::error::Tag $GITHUB_REF_NAME does not match VERSION file ($VERSION)"
            exit 1
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Create source tarball
        run: |
          git archive --format=tar.gz --prefix="libxml2-${VERSION}/" -o "libxml2-${VERSION}.tar.gz" HEAD

      - name: Build with CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j"$(nproc)"

      - name: Generate checksums
        run: |
          sha256sum "libxml2-${VERSION}.tar.gz" > SHA256SUMS

      - name: Generate SBOM
        uses: anchore/sbom-action@17ae1740179002c89186b61233e0f892c3118b11 # v0.23.0
        with:
          path: .
          format: cyclonedx-json
          output-file: sbom.json

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Sign artifacts with cosign
        run: |
          cosign sign-blob --yes "libxml2-${VERSION}.tar.gz" --bundle "libxml2-${VERSION}.tar.gz.bundle"
          cosign sign-blob --yes SHA256SUMS --bundle SHA256SUMS.bundle
          cosign sign-blob --yes sbom.json --bundle sbom.json.bundle

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@a2bbfa25375fe432b6a289bc6b6cd05ecd0c4c32 # v4.1.0
        with:
          subject-path: "libxml2-${{ env.VERSION }}.tar.gz"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          generate_release_notes: true
          files: |
            libxml2-${{ env.VERSION }}.tar.gz
            SHA256SUMS
            sbom.json
            libxml2-${{ env.VERSION }}.tar.gz.bundle
            SHA256SUMS.bundle
            sbom.json.bundle
